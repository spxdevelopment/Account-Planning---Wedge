<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SalesSparx Wedge Portal</title>
  <style>
    /* SALESSPARX BRANDING & CORE STYLES */
    :root {
      --primary: #00A7B3; /* SPX Teal */
      --secondary: #EB5C22; /* SPX Orange */
      --dark-bg: #1F2933;
      --light-bg: #ECEFF3;
      --card-bg: #FFFFFF;
      --text-color: #1F2933;
    }

    body {
      margin: 0;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* LAYOUT UTILS */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .hidden { display: none !important; }

    /* HEADER */
    header {
      background: white;
      padding: 1rem 2rem;
      border-bottom: 4px solid var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--text-color);
      text-decoration: none;
    }
    .logo span { color: var(--secondary); }

    .api-key-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* MENU CARDS (HOME) */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .menu-card {
      background: white;
      padding: 2.5rem;
      border-radius: 12px;
      border: 1px solid #e1e4e8;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      text-align: center;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
      border-color: var(--primary);
    }

    .menu-card h3 { color: var(--primary); margin-top: 0; font-size: 1.5rem; }
    .menu-card p { color: #666; font-size: 0.95rem; }
    
    /* FORMS & INPUTS */
    .app-view {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      margin-top: 2rem;
    }

    h1, h2 { color: var(--text-color); }
    h2 { border-bottom: 2px solid var(--secondary); padding-bottom: 0.5rem; margin-bottom: 1.5rem; display: inline-block; }

    label { display: block; font-weight: bold; margin-top: 1rem; color: var(--text-color); font-size: 0.9rem; }
    input[type="text"], input[type="password"], textarea, select {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
    }

    textarea { min-height: 100px; resize: vertical; }

    /* BUTTONS */
    .btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      margin-top: 1.5rem;
      transition: background 0.2s;
    }
    .btn:hover { background-color: #008c96; }
    .btn-secondary { background-color: #6c757d; margin-right: 10px; }
    .btn-secondary:hover { background-color: #5a6268; }

    /* MATURITY ASSESSMENT SPECIFIC */
    .question-block { margin-bottom: 2rem; }
    .options-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .option-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      min-width: 120px;
    }
    .option-btn.selected {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* OUTPUT AREA (PLANNER) */
    .output-area {
      margin-top: 2rem;
      padding: 2rem;
      background: #f8f9fa;
      border-left: 5px solid var(--secondary);
      border-radius: 4px;
    }
    
    .loading {
      text-align: center;
      color: var(--secondary);
      font-weight: bold;
      display: none;
    }

    /* Print styling */
    @media print {
      header, .menu-grid, .form-section, .btn { display: none; }
      .app-view { box-shadow: none; padding: 0; }
      .output-area { border: none; padding: 0; }
    }
  </style>
</head>
<body>

  <header>
    <a href="#" class="logo" onclick="goHome()">sales<span>SPARX</span></a>
    <div class="api-key-wrapper">
      <input type="password" id="geminiKey" placeholder="Paste Google Gemini API Key" style="margin-top:0; padding: 8px; width: 250px;">
    </div>
  </header>

  <div class="container">
    
    <div id="view-home">
      <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="color: var(--primary); font-size: 2.5rem;">Wedge Account Planning Portal</h1>
        <p style="font-size: 1.2rem; color: #666;">Select a tool to begin.</p>
      </div>

      <div class="menu-grid">
        <div class="menu-card" onclick="switchView('view-maturity')">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üß†</div>
          <h3>AI Maturity Assessment</h3>
          <p>Evaluate your team's readiness for AI-driven account planning. 7 Questions.</p>
        </div>

        <div class="menu-card" onclick="switchView('view-simplified')">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö°</div>
          <h3>Simplified Account Plan</h3>
          <p>For the "Wedge" sales process. Generates a strategic plan using only outside-in public data.</p>
        </div>

        <div class="menu-card" onclick="switchView('view-detailed')">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìò</div>
          <h3>Detailed Account Plan</h3>
          <p>Full SPX template structure. Requires internal data (revenue, relationships, whitespace).</p>
        </div>
      </div>
    </div>

    <div id="view-maturity" class="app-view hidden">
      <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
      <h2>Account Planning AI Maturity</h2>
      <p>Assess how effectively your organization integrates AI and co-creation into planning.</p>
      
      <div id="maturity-questions"></div>
      
      <button class="btn" onclick="calculateMaturity()">Analyze Results</button>
      
      <div id="maturity-result" class="output-area hidden"></div>
    </div>

    <div id="view-simplified" class="app-view hidden">
      <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
      <h2>Simplified Account Plan (Wedge)</h2>
      <p>Use this during the sales process when access to internal client data is limited.</p>

      <div class="form-section">
        <label>Target Account Name</label>
        <input type="text" id="simp-account" placeholder="e.g. Mayo Clinic">

        <label>Account Industry / Context</label>
        <textarea id="simp-context" placeholder="e.g. Large non-profit hospital system facing margin compression..."></textarea>

        <label>Your Offering (The "Wedge")</label>
        <textarea id="simp-offering" placeholder="e.g. Clinical workflow software that reduces nurse burnout..."></textarea>

        <button class="btn" onclick="generateSimplifiedPlan()">‚ú® Generate Simplified Plan</button>
      </div>

      <div id="simp-loading" class="loading"><br>Consulting Gemini AI...<br>Analyzing Public Signals...</div>
      <div id="simp-output" class="output-area hidden"></div>
    </div>

    <div id="view-detailed" class="app-view hidden">
      <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
      <h2>Detailed Account Plan (SPX Template)</h2>
      <p>For active engagements. Inputs align with <em>SPX_Account_Plan_Template2025</em>.</p>

      <div class="form-section">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <label>Account Name</label>
            <input type="text" id="det-account">
          </div>
          <div>
            <label>Current SPX Revenue (FY25)</label>
            <input type="text" id="det-revenue" placeholder="$0">
          </div>
        </div>

        <label>Gap to Goal (The Financial Math)</label>
        <input type="text" id="det-gap" placeholder="e.g. Need $500k in new expansion revenue">

        <label>Known Whitespace (Where can we sell?)</label>
        <textarea id="det-whitespace" placeholder="List areas: 1. RevOps (Signal Present), 2. Org Design (No Signal)..."></textarea>

        <label>Key Relationships (Who do we know?)</label>
        <textarea id="det-relationships" placeholder="e.g. CFO (Trusted Advisor), CIO (Unknown), VP Sales (Blocker)"></textarea>

        <label>Strategic Objective</label>
        <textarea id="det-strategy" placeholder="What is the Single Sales Objective?"></textarea>

        <button class="btn" onclick="generateDetailedPlan()">‚ú® Generate Detailed Plan</button>
      </div>

      <div id="det-loading" class="loading"><br>Consulting Gemini AI...<br>Structuring Deep Analysis...</div>
      <div id="det-output" class="output-area hidden"></div>
    </div>

  </div>

<script>
/* =========================================
   1. NAVIGATION LOGIC
   ========================================= */
function goHome() {
  document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
  document.getElementById('view-home').classList.remove('hidden');
}

function switchView(viewId) {
  document.getElementById('view-home').classList.add('hidden');
  document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
  document.getElementById(viewId).classList.remove('hidden');
}

/* =========================================
   2. MATURITY ASSESSMENT LOGIC
   ========================================= */
const maturityQuestions = [
  { id: 1, text: "Data Readiness: Is account data centralized and accessible?", options: ["Scatterred/Manual", "Some Centralization", "CRM Integrated", "Clean API Access", "Fully AI Ready"] },
  { id: 2, text: "Buyer Signals: How do you track 'Why Change Now'?", options: ["Ad-hoc Search", "Manual Alerts", "Basic Tools", "Automated Feeds", "AI Signal Mapping"] },
  { id: 3, text: "Co-Creation: How often do you validate plans with clients?", options: ["Never", "Rarely", "Sometimes", "Often", "Always (Live)"] },
  { id: 4, text: "Expansion Logic: How is whitespace identified?", options: ["Guesswork", "Rep Intuition", "Manual Mapping", "Data-Driven", "AI Predictive"] },
  { id: 5, text: "Inspection: Can leadership audit plans instantly?", options: ["No (Docs)", "No (Meetings)", "Somewhat", "Yes (Dashboards)", "Yes (AI Rubric)"] },
  { id: 6, text: "Relationship Scoring: How do you measure influence?", options: ["Subjective", "Vague", "Defined Levels", "Evidence-Based", "Automated Scoring"] },
  { id: 7, text: "Prompt Engineering: Do you use standardized AI prompts?", options: ["None", "Ad-hoc", "Some Templates", "Library Exists", "Integrated Workflow"] }
];

// Render Questions
const qContainer = document.getElementById('maturity-questions');
maturityQuestions.forEach((q, idx) => {
  const html = `
    <div class="question-block" id="qblock-${idx}">
      <label>${idx+1}. ${q.text}</label>
      <div class="options-row">
        ${q.options.map((opt, optIdx) => `
          <div class="option-btn" onclick="selectOption(${idx}, ${optIdx+1}, this)">${opt}</div>
        `).join('')}
      </div>
    </div>
  `;
  qContainer.insertAdjacentHTML('beforeend', html);
});

let maturityScores = new Array(maturityQuestions.length).fill(0);

function selectOption(qIdx, score, elem) {
  maturityScores[qIdx] = score;
  // Visual Feedback
  const parent = document.getElementById(`qblock-${qIdx}`);
  parent.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
  elem.classList.add('selected');
}

async function calculateMaturity() {
  if (maturityScores.includes(0)) { alert("Please answer all questions."); return; }
  
  const total = maturityScores.reduce((a,b) => a+b, 0);
  const avg = (total / maturityQuestions.length).toFixed(1);
  
  // Call Gemini for the textual analysis
  const prompt = `
    You are an expert Sales Consultant. A client just took an "AI Account Planning Maturity Assessment".
    Their Score: ${avg} / 5.
    
    Rubric:
    1-2: Emerging (Reactive, Manual)
    3-4: Advanced (Process-driven, some tools)
    5: Leading (AI-native, Predictive)

    Generate a concise HTML summary (no markdown backticks) with:
    <h3>Maturity Level: [Insert Level]</h3>
    <p>Summary of their status.</p>
    <ul>3 bullet points on specific next steps to improve their score.</ul>
  `;

  document.getElementById('maturity-result').classList.remove('hidden');
  document.getElementById('maturity-result').innerHTML = "Analyzing scores...";
  
  const response = await callGemini(prompt);
  document.getElementById('maturity-result').innerHTML = response;
}

/* =========================================
   3. SIMPLIFIED PLANNER LOGIC
   ========================================= */
async function generateSimplifiedPlan() {
  const account = document.getElementById('simp-account').value;
  const context = document.getElementById('simp-context').value;
  const offering = document.getElementById('simp-offering').value;
  
  if(!account) { alert("Please enter an account name."); return; }

  const prompt = `
    Act as a Senior Account Strategist. 
    Create a "Simplified Account Plan" for the Wedge Offering.
    
    TARGET ACCOUNT: ${account}
    CONTEXT: ${context}
    OFFERING: ${offering}
    
    Constraint: You do NOT have inside information. Do not invent specific relationships. Focus on Public Signals (10-Ks, News).
    
    Generate output in clear HTML format (no markdown backticks, use <h3> for headers):
    
    1. <h3>Executive Summary</h3>: 3 bullet points on why they need to change NOW (Industry Pains).
    2. <h3>Outside-In Whitespace Map</h3>: Create an HTML Table with columns "Business Objective", "Why Change Now (Signal)", "Our Wedge Solution". List 3 rows.
    3. <h3>The Hook</h3>: Draft a cold email intro (3 sentences) linking a public event to the offering.
  `;

  document.getElementById('simp-loading').style.display = 'block';
  document.getElementById('simp-output').classList.add('hidden');

  const response = await callGemini(prompt);

  document.getElementById('simp-loading').style.display = 'none';
  document.getElementById('simp-output').innerHTML = response;
  document.getElementById('simp-output').classList.remove('hidden');
}

/* =========================================
   4. DETAILED PLANNER LOGIC
   ========================================= */
async function generateDetailedPlan() {
  const account = document.getElementById('det-account').value;
  const revenue = document.getElementById('det-revenue').value;
  const gap = document.getElementById('det-gap').value;
  const whitespace = document.getElementById('det-whitespace').value;
  const rels = document.getElementById('det-relationships').value;
  const strategy = document.getElementById('det-strategy').value;

  if(!account) { alert("Please enter account details."); return; }

  const prompt = `
    Act as a SalesSparx Account Planning Expert.
    Create a "Detailed Account Plan" following the SPX Template structure.

    CLIENT DATA:
    Account: ${account}
    Revenue: ${revenue}
    Gap to Goal: ${gap}
    Whitespace: ${whitespace}
    Relationships: ${rels}
    Strategy: ${strategy}

    Generate output in clear HTML format (no markdown backticks). Style with CSS classes provided in the page.
    
    Structure:
    1. <h3>Account Overview</h3>: Table showing Current Revenue vs Goal.
    2. <h3>Gap Analysis</h3>: Analyze the "${gap}" and suggest if the identified whitespace (${whitespace}) is sufficient to cover it.
    3. <h3>Relationship Map (Evidence-Based)</h3>: Create a table of the relationships provided. Add a column "Recommended Next Action" for each person based on their status.
    4. <h3>Strategic Narrative</h3>: Write a "Why Change, Why Now, Why Us" narrative based on the strategy input.
    5. <h3>30/60/90 Day Execution Plan</h3>: Bullet points for immediate actions.
  `;

  document.getElementById('det-loading').style.display = 'block';
  document.getElementById('det-output').classList.add('hidden');

  const response = await callGemini(prompt);

  document.getElementById('det-loading').style.display = 'none';
  document.getElementById('det-output').innerHTML = response;
  document.getElementById('det-output').classList.remove('hidden');
}

/* /* =========================================
   5. GEMINI API CALLER
   ========================================= */
async function callGemini(promptText) {
  
  // LOGIC:
  // 1. If Render replaced "INSERT_API_KEY_HERE" with a real key, use it.
  // 2. Otherwise, grab whatever is typed in the input box at the top of the screen.
  
  const renderKey = "AIzaSyCaRrxI3auvsS_DyMbp-dpl1NMssS8xrwY"; 
  
  // Check if the placeholder is still there or if Render replaced it
  const apiKey = renderKey !== "IAIzaSyCaRrxI3auvsS_DyMbp-dpl1NMssS8xrwY" 
    ? renderKey 
    : document.getElementById('geminiKey').value;

  if (!apiKey) {
    alert("Please paste your Gemini API Key in the top right corner.");
    // Hide loading spinners if they are active
    if(document.getElementById('simp-loading')) document.getElementById('simp-loading').style.display = 'none';
    if(document.getElementById('det-loading')) document.getElementById('det-loading').style.display = 'none';
    return "API Key Missing";
  }

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{
      parts: [{ text: promptText }]
    }]
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (data.error) {
      return `Error: ${data.error.message}`;
    }
    
    let rawText = data.candidates[0].content.parts[0].text;
    // Clean up Markdown code blocks if Gemini sends them
    return rawText.replace(/```html/g, '').replace(/```/g, '');

  } catch (error) {
    return `Connection Error: ${error.message}`;
  }
}
