<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SalesSparx Account Planning Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* =========================================
       SALESSPARX BRAND SYSTEM (Jan 2024)
       ========================================= */
    :root {
      --spx-teal: #4CA09A;
      --spx-dark-teal: #147E76;
      --spx-red: #CA2027;     /* Primary Accent */
      --spx-black: #000000;   /* Primary Text */
      --spx-orange: #EE6C3C;  /* Secondary Accent */
      --spx-yellow: #FFF33B;
      --bg-light: #F4F6F8;
      --card-white: #FFFFFF;
      --border-color: #E1E4E8;
    }

    body {
      margin: 0;
      font-family: 'Avenir', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
      color: var(--spx-black);
      line-height: 1.5;
      font-size: 14px;
    }

    /* === HEADER === */
    header {
      background: var(--card-white);
      border-bottom: 4px solid var(--spx-teal);
      padding: 15px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .logo-img { height: 45px; width: auto; }
    .header-title { font-weight: bold; color: var(--spx-dark-teal); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

    /* === LAYOUT === */
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .hidden { display: none !important; }

    /* === LOBBY MENU === */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
      margin-top: 40px;
    }

    .menu-card {
      background: var(--card-white);
      padding: 40px 30px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s ease;
      border-top: 6px solid var(--spx-black);
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.08);
      border-top-color: var(--spx-red);
    }

    .menu-card h3 { font-size: 1.4rem; margin: 0 0 10px 0; color: var(--spx-black); }
    .menu-card p { font-size: 0.95rem; color: #666; margin: 0; }

    /* === APP VIEWS (FORMS) === */
    .app-view {
      background: var(--card-white);
      border-radius: 8px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      animation: fadeIn 0.3s ease-in-out;
      margin-bottom: 50px;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--bg-light);
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .view-header h2 { margin: 0; color: var(--spx-teal); font-size: 1.8rem; }

    /* === FORM ELEMENTS === */
    .form-section-title {
      font-size: 1.1rem;
      color: var(--spx-dark-teal);
      border-left: 4px solid var(--spx-orange);
      padding-left: 10px;
      margin: 30px 0 15px 0;
      font-weight: bold;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .full-width { grid-column: span 2; }
    
    .form-group { margin-bottom: 20px; }
    
    label {
      display: block;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--spx-black);
    }
    
    .sub-label {
      display: block;
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 8px;
      font-style: italic;
    }

    input[type="text"], textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      color: var(--spx-black);
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--spx-teal); outline: none; }
    textarea { min-height: 100px; resize: vertical; }

    /* === MATURITY ASSESSMENT TABLE === */
    .mat-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    .mat-table th { text-align: left; padding: 15px; background: var(--bg-light); border-bottom: 2px solid var(--spx-teal); color: var(--spx-dark-teal); font-size: 1rem; }
    .mat-table td { padding: 15px; border-bottom: 1px solid #eee; }
    .mat-category { background: #fafafa; font-weight: bold; color: var(--spx-orange); text-transform: uppercase; font-size: 0.85rem; padding-top: 20px; }

    .scale-row { display: flex; gap: 5px; }
    .scale-btn {
      flex: 1;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .scale-btn:hover { background: var(--bg-light); }
    .scale-btn.selected {
      background: var(--spx-teal);
      color: white;
      border-color: var(--spx-teal);
      font-weight: bold;
    }

    /* === BUTTONS === */
    .btn-primary {
      background: var(--spx-teal);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn-primary:hover { background: var(--spx-dark-teal); }

    .btn-outline {
      background: white;
      border: 1px solid #ccc;
      color: #666;
      padding: 8px 20px;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-outline:hover { background: #f9f9f9; color: var(--spx-black); }

    /* === OUTPUT CONTAINER (PDF STYLE) === */
    .output-wrapper {
      margin-top: 40px;
      background: white;
      padding: 60px;
      border: 1px solid #ddd;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      display: none;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
      max-width: 600px;
      margin: 30px auto;
    }

    /* === LOADER === */
    .loader {
      display: none;
      text-align: center;
      padding: 60px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--spx-teal);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* === PRINT STYLES === */
    @media print {
      body { background: white; }
      header, .menu-grid, .app-view, .btn-primary, .btn-outline, .no-print { display: none !important; }
      .container { width: 100%; max-width: 100%; padding: 0; margin: 0; }
      .output-wrapper {
        display: block !important;
        border: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
      }
    }
  </style>
</head>
<body>

  <header class="no-print">
    <img src="wide - Copy.jpg" alt="SalesSparx" class="logo-img">
    <div class="header-title">Account Planning Portal</div>
  </header>

  <div class="container no-print" id="lobby">
    <div style="text-align: center; margin-bottom: 40px;">
      <h1 style="font-size: 2.2rem; margin-bottom: 10px; color: var(--spx-black);">Account Planning</h1>
      <p style="color: #666; font-size: 1.1rem;">Choose the environment based on the engagement stage.</p>
    </div>

    <div class="menu-grid">
      <div class="menu-card" onclick="switchView('maturity')">
        <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ§ </div>
        <h3>Maturity Assessment</h3>
        <p>10-Question Diagnostic & Radar Chart</p>
      </div>
      <div class="menu-card" onclick="switchView('simplified')">
        <div style="font-size: 2rem; margin-bottom: 10px;">âš¡</div>
        <h3>Simplified Plan</h3>
        <p>Outside-In (Public Data Focus)</p>
      </div>
      <div class="menu-card" onclick="switchView('detailed')">
        <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ“˜</div>
        <h3>Detailed Plan</h3>
        <p>Inside-Out (Financials & Relationships)</p>
      </div>
    </div>
  </div>

  <div class="container hidden" id="view-maturity">
    <div class="app-view">
      <div class="view-header">
        <h2>AI + Buyer Co-Creation Maturity</h2>
        <button class="btn-outline" onclick="goHome()">Back to Menu</button>
      </div>
      
      <p style="margin-bottom: 20px; background: var(--bg-light); padding: 15px; border-left: 4px solid var(--spx-orange);">
        <strong>Instructions:</strong> Rate 1 (Ad Hoc / No AI) to 5 (Integrated Co-Creation). All 10 questions are required to generate the Radar Chart.
      </p>

      <div id="maturity-form"></div>

      <div style="text-align: right; margin-top: 30px;">
        <button class="btn-primary" onclick="runMaturity()">Generate Maturity Report</button>
      </div>
    </div>
  </div>

  <div class="container hidden" id="view-simplified">
    <div class="app-view">
      <div class="view-header">
        <h2>Simplified Account Plan (Outside-In)</h2>
        <button class="btn-outline" onclick="goHome()">Back to Menu</button>
      </div>

      <div class="form-section-title">1. Seller Information</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Company Name</label>
          <input type="text" id="simp-seller-name" placeholder="e.g. Clinical Tech Solutions">
        </div>
        <div class="form-group">
          <label>Website</label>
          <input type="text" id="simp-seller-web" value="https://">
        </div>
        <div class="form-group full-width">
          <label>Company Description</label>
          <input type="text" id="simp-seller-desc" placeholder="e.g. $25M ARR; healthcare services provider; competitive advantage is speed...">
        </div>
      </div>

      <div class="form-section-title">2. Target Account (Buyer)</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Target Account Name</label>
          <input type="text" id="simp-buyer-name" placeholder="e.g. Mayo Clinic">
        </div>
        <div class="form-group">
          <label>Target Website</label>
          <input type="text" id="simp-buyer-web" value="https://">
        </div>
        <div class="form-group full-width">
          <label>Target Description / Context</label>
          <input type="text" id="simp-buyer-desc" placeholder="Industry context, size, recent news, known pressures...">
        </div>
      </div>

      <div class="form-section-title">3. Strategic Goals</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Strategic Goal</label>
          <input type="text" id="simp-goal" value="Expansion + new buying center penetration">
        </div>
        <div class="form-group">
          <label>Time Horizon</label>
          <input type="text" id="simp-time" value="12 months">
        </div>
      </div>

      <div style="text-align: right; margin-top: 30px;">
        <button class="btn-primary" onclick="runSimplified()">Generate Simplified Plan</button>
      </div>
    </div>
  </div>

  <div class="container hidden" id="view-detailed">
    <div class="app-view">
      <div class="view-header">
        <h2>Detailed Account Plan (Inside-Out)</h2>
        <button class="btn-outline" onclick="goHome()">Back to Menu</button>
      </div>

      <div class="form-section-title">1. Core Profile</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Seller Name</label>
          <input type="text" id="det-seller-name">
        </div>
        <div class="form-group">
          <label>Buyer Name</label>
          <input type="text" id="det-buyer-name">
        </div>
        <div class="form-group">
          <label>Strategic Goal</label>
          <input type="text" id="det-goal" value="Expansion + new buying center penetration">
        </div>
        <div class="form-group">
          <label>Time Horizon</label>
          <input type="text" id="det-time" value="12 months">
        </div>
      </div>

      <div class="form-section-title">2. Financial & Whitespace Analysis</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Gap to Goal ($)</label>
          <input type="text" id="det-gap" placeholder="e.g. $500k revenue shortfall">
        </div>
        <div class="form-group">
          <label>Whitespace Analysis (Signal vs. No Signal)</label>
          <span class="sub-label">Format: 1. Area (Signal Status: Evidence)</span>
          <textarea id="det-whitespace" placeholder="1. RevOps (Strong Signal: New CRO hired)&#10;2. Clinical Training (No Signal: Budget freeze)"></textarea>
        </div>
      </div>

      <div class="form-section-title">3. Relationship Intelligence</div>
      <div class="form-group">
        <label>Relationship Map (Evidence-Based)</label>
        <span class="sub-label">List stakeholders and 'Evidence Score' (Trusted Advisor, Awareness, etc.)</span>
        <textarea id="det-relationships" placeholder="John Doe - CFO (Trusted Advisor: invited us to planning)&#10;Jane Smith - CIO (Awareness: responds to emails)"></textarea>
      </div>

      <div class="form-section-title">4. Strategy</div>
      <div class="form-group">
        <label>Account Strategy (The "Why")</label>
        <span class="sub-label">Why Change? Why Now? Why Us?</span>
        <textarea id="det-strategy" placeholder="Strategic narrative connecting buyer pains to our offering..."></textarea>
      </div>

      <div style="text-align: right; margin-top: 30px;">
        <button class="btn-primary" onclick="runDetailed()">Generate Detailed Plan</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="loader" class="loader">
      <div class="spinner"></div>
      <p style="font-weight: bold; color: var(--spx-teal); font-size: 1.2rem;">SalesSparx AI is Analyzing...</p>
      <p style="font-size: 0.9rem; color: #666;">Applying Enterprise Strategy Logic...</p>
    </div>

    <div id="output-wrapper" class="output-wrapper">
      <div class="no-print" style="text-align: right; margin-bottom: 20px;">
        <button class="btn-outline" onclick="window.print()">Download PDF</button>
        <button class="btn-outline" onclick="location.reload()">Start Over</button>
      </div>
      <div id="output-content"></div>
    </div>
  </div>

<script>
/* =======================================================
   1) BACKEND CONFIGURATION (Render Proxy)
   IMPORTANT:
   - Replace API_BASE with your Render backend URL
   - Example: https://spx-account-planning-proxy.onrender.com
   ======================================================= */
const API_BASE = "https://account-planning-portal.onrender.com";

/* =========================================
   NAVIGATION LOGIC
   ========================================= */
function goHome() {
  document.getElementById('view-maturity').classList.add('hidden');
  document.getElementById('view-simplified').classList.add('hidden');
  document.getElementById('view-detailed').classList.add('hidden');
  document.getElementById('lobby').classList.remove('hidden');
  document.getElementById('output-wrapper').style.display = 'none';
}

function switchView(viewId) {
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('output-wrapper').style.display = 'none';
  document.getElementById(`view-${viewId}`).classList.remove('hidden');
}

/* =========================================
   MATURITY ASSESSMENT LOGIC
   ========================================= */
const matData = [
  { cat: "A. AI Use in Account Planning", qs: [
    "A1. Do teams use AI to generate account insights from public + internal sources?",
    "A2. Are AI outputs captured in the account plan template (not random notes)?",
    "A3. Do teams use AI to segment whitespace by 'Buyer Signal' vs 'No Signal'?",
    "A4. Do teams use AI to generate hypotheses for 'Why Change / Why Now'?"
  ]},
  { cat: "B. Buyer Co-Creation", qs: [
    "B1. How consistently is change urgency validated directly with the buyer?",
    "B2. Do teams use AI to prepare 'co-creation' discussion guides?",
    "B3. Do plans include evidence-based relationship scoring?",
    "B4. Is AI used to map stakeholders and decision process gaps?"
  ]},
  { cat: "C. Governance", qs: [
    "C1. Can leadership inspect plan quality with a standard rubric?",
    "C2. Is there governance for AI use (validation rules, citations)?"
  ]}
];

let matScores = new Array(10).fill(0);
const mForm = document.getElementById('maturity-form');
let mHtml = "";
let qIdx = 0;

matData.forEach(section => {
  mHtml += `<div class="mat-category">${section.cat}</div><table class="mat-table"><tbody>`;
  section.qs.forEach(q => {
    mHtml += `<tr><td style="width:60%">${q}</td><td><div class="scale-row">
      ${[1,2,3,4,5].map(v => `<div class="scale-btn" onclick="rate(${qIdx},${v},this)">${v}</div>`).join('')}
    </div></td></tr>`;
    qIdx++;
  });
  mHtml += `</tbody></table>`;
});
mForm.innerHTML = mHtml;

function rate(idx, val, el) {
  matScores[idx] = val;
  el.parentElement.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

async function runMaturity() {
  if (matScores.includes(0)) { alert("Please rate all 10 questions."); return; }
  
  const score = matScores.reduce((a,b)=>a+b,0);
  const aiScore = (matScores[0]+matScores[1]+matScores[2]+matScores[3])/4;
  const coScore = (matScores[4]+matScores[5]+matScores[6]+matScores[7])/4;
  const govScore = (matScores[8]+matScores[9])/2;

  const prompt = `
    Role: SalesSparx Senior Partner.
    Task: Generate a Detailed Maturity Assessment Report.
    DATA: Score ${score}/50. AI Readiness: ${aiScore}/5. Co-Creation: ${coScore}/5. Governance: ${govScore}/5.
    
    OUTPUT FORMAT (HTML):
    <h1 style="color:#4CA09A; border-bottom:3px solid #000; padding-bottom:10px;">Maturity Assessment Report</h1>
    <div style="background:#f4f4f4; padding:20px; border-left:6px solid #CA2027; margin:20px 0;">
      <h2 style="margin:0;">Total Score: ${score}/50</h2>
      <p style="margin:5px 0;"><strong>Status:</strong> ${score < 30 ? 'Ad Hoc / Emerging' : score < 40 ? 'Operational' : 'Strategic Co-Creation'}</p>
    </div>
    <div class="chart-container"><canvas id="matChart"></canvas></div>
    <h3 style="color:#1F2933; margin-top:30px;">Executive Summary</h3>
    <p>[Write 1 paragraph analyzing their maturity. Be direct and professional.]</p>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
      <div style="border:1px solid #ddd; padding:15px;">
        <h4 style="color:#4CA09A; margin-top:0;">Top Strengths</h4>
        <ul>[List 3 specific strengths based on high scores]</ul>
      </div>
      <div style="border:1px solid #ddd; padding:15px;">
        <h4 style="color:#CA2027; margin-top:0;">Critical Gaps</h4>
        <ul>[List 3 specific gaps based on low scores]</ul>
      </div>
    </div>
    <h3 style="color:#1F2933;">Recommended Roadmap</h3>
    <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee;">
      <tr style="background:#f9f9f9;"><th>Phase</th><th>Focus Area</th><th>Key Deliverable</th></tr>
      <tr><td><strong>Immediate</strong></td><td>[Area 1]</td><td>[Action 1]</td></tr>
      <tr><td><strong>30 Days</strong></td><td>[Area 2]</td><td>[Action 2]</td></tr>
      <tr><td><strong>90 Days</strong></td><td>[Area 3]</td><td>[Action 3]</td></tr>
    </table>
  `;

  const responseHtml = await callOpenAI(prompt);
  if (!responseHtml) return;

  renderOutput(responseHtml);
  
  setTimeout(() => {
    const ctx = document.getElementById('matChart');
    if(ctx) {
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['AI Readiness', 'Buyer Co-Creation', 'Governance'],
          datasets: [{
            label: 'Current Maturity Level',
            data: [aiScore, coScore, govScore],
            backgroundColor: 'rgba(76, 160, 154, 0.2)',
            borderColor: '#4CA09A',
            pointBackgroundColor: '#CA2027',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#CA2027',
            borderWidth: 2
          }]
        },
        options: {
          scales: { r: { min: 0, max: 5, ticks: {stepSize: 1}, pointLabels: {font: {size: 14}} } }
        }
      });
    }
  }, 500);
}

/* =========================================
   SIMPLIFIED PLANNER LOGIC
   ========================================= */
async function runSimplified() {
  const seller = document.getElementById('simp-seller-name').value;
  const buyer = document.getElementById('simp-buyer-name').value;
  const buyerDesc = document.getElementById('simp-buyer-desc').value;
  const goal = document.getElementById('simp-goal').value;
  
  if(!seller || !buyer) { alert("Company names required."); return; }

  const prompt = `
    Role: Enterprise Account Strategist (SalesSparx).
    Objective: Produce a Simplified Account Plan (Outside-In).
    
    INPUTS:
    Seller: ${seller} (Web: ${document.getElementById('simp-seller-web').value}) - ${document.getElementById('simp-seller-desc').value}
    Buyer: ${buyer} (Web: ${document.getElementById('simp-buyer-web').value}) - ${buyerDesc}
    Goal: ${goal} | Horizon: ${document.getElementById('simp-time').value}
    
    TASK:
    Review public info for ${buyer}. Generate a detailed plan.
    
    OUTPUT FORMAT (HTML):
    <div style="font-family: sans-serif;">
      <h1 style="color:#4CA09A; border-bottom:3px solid #000;">Simplified Account Plan: ${buyer}</h1>
      <p><strong>Prepared For:</strong> ${seller} | <strong>Goal:</strong> ${goal}</p>

      <h3 style="background:#f4f4f4; padding:10px; color:#1F2933;">1. Account Snapshot</h3>
      <ul style="columns: 2;">
        <li><strong>Business Model:</strong> [Analysis]</li>
        <li><strong>Top Pressure:</strong> [Why Change Now]</li>
        <li><strong>Forcing Function:</strong> [Regulation/Event]</li>
        <li><strong>Strategic Priority:</strong> [Inferred]</li>
      </ul>

      <h3 style="background:#f4f4f4; padding:10px; color:#1F2933;">2. Whitespace Map (Outside-In)</h3>
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee;">
        <tr style="background:#4CA09A; color:white;"><th>Opportunity Area</th><th>Signal Status</th><th>Trigger Evidence</th></tr>
        <tr><td>[Area 1]</td><td><strong>WITH Signal</strong></td><td>[Evidence from News/Jobs/10K]</td></tr>
        <tr><td>[Area 2]</td><td>NO Signal</td><td>[Logical whitespace but no public trigger]</td></tr>
        <tr><td>[Area 3]</td><td>NO Signal</td><td>[Logical whitespace but no public trigger]</td></tr>
      </table>

      <h3 style="background:#f4f4f4; padding:10px; color:#1F2933;">3. Stakeholder Hypotheses</h3>
      <p><strong>Economic Buyer:</strong> [Likely Role] | <strong>Champion:</strong> [Likely Role]</p>
      <p style="color:#CA2027;"><strong>Validation Required:</strong> [List specific unknowns to validate in first meeting]</p>

      <h3 style="background:#f4f4f4; padding:10px; color:#1F2933;">4. 12-Month Strategy</h3>
      <ul>
        <li><strong>Objective:</strong> [Strategic Statement]</li>
        <li><strong>Q1 Focus:</strong> [Action]</li>
        <li><strong>Q2 Focus:</strong> [Action]</li>
      </ul>
      
      <div style="border:1px dashed #999; padding:15px; margin-top:20px;">
        <strong>Inspection Check:</strong>
        <br>[ ] Is the "Why Change" quantified?
        <br>[ ] Is the Economic Buyer identified?
      </div>
    </div>
  `;

  const html = await callOpenAI(prompt);
  if(html) renderOutput(html);
}

/* =========================================
   DETAILED PLANNER LOGIC
   ========================================= */
async function runDetailed() {
  const seller = document.getElementById('det-seller-name').value;
  const buyer = document.getElementById('det-buyer-name').value;
  const gap = document.getElementById('det-gap').value;
  
  if(!seller || !buyer) { alert("Required fields missing."); return; }

  const prompt = `
    Role: SalesSparx Senior Partner.
    Objective: Detailed Account Plan (Inside-Out).
    
    INPUTS:
    Seller: ${seller} | Buyer: ${buyer}
    Gap to Goal: ${gap}
    Whitespace Analysis: ${document.getElementById('det-whitespace').value}
    Relationships: ${document.getElementById('det-relationships').value}
    Strategy: ${document.getElementById('det-strategy').value}
    
    STRICT RULES:
    1. Score Relationships: Trusted Advisor > Trusted > Building > Awareness > Unknown.
    2. Validate Gap: Does Whitespace cover ${gap}?
    3. Output must be executive-ready.

    OUTPUT FORMAT (HTML):
    <div style="font-family: sans-serif;">
      <h1 style="color:#4CA09A; border-bottom:3px solid #000;">Detailed Account Plan: ${buyer}</h1>
      
      <div style="display:flex; justify-content:space-between; background:#f4f4f4; padding:15px; border-left:6px solid #CA2027;">
        <div><strong>Strategic Goal:</strong> Expansion</div>
        <div><strong>Gap to Goal:</strong> ${gap}</div>
      </div>

      <h3 style="color:#1F2933;">1. Financial & Whitespace Validation</h3>
      <p>[Critique: Is the pipeline sufficient to close the ${gap} gap? Be critical.]</p>
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee;">
        <tr style="background:#4CA09A; color:white;"><th>Focus Area</th><th>Signal Strength</th><th>Revenue Impact</th></tr>
        <tr><td>[Area 1]</td><td>[Strong/Weak]</td><td>[High/Med/Low]</td></tr>
        <tr><td>[Area 2]</td><td>[Strong/Weak]</td><td>[High/Med/Low]</td></tr>
      </table>

      <h3 style="color:#1F2933;">2. Evidence-Based Relationship Map</h3>
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee;">
        <tr style="background:#eee;"><th>Stakeholder</th><th>Score</th><th>Evidence/Gap</th></tr>
        <tr><td>[Name/Role]</td><td>[Score]</td><td>[Evidence provided or missing]</td></tr>
        <tr><td>[Name/Role]</td><td>[Score]</td><td>[Evidence provided or missing]</td></tr>
      </table>

      <h3 style="color:#1F2933;">3. Strategic Narrative (Refined)</h3>
      <p style="font-style:italic; border-left:3px solid #ccc; padding-left:10px;">"[Refined Why Change / Why Now / Why Us narrative]"</p>

      <h3 style="color:#1F2933;">4. 30/60/90 Execution Plan</h3>
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee;">
        <tr style="background:#f4f4f4;"><th>Timeframe</th><th>Focus Area</th><th>Key Deliverable</th></tr>
        <tr><td><strong>Day 30 (Validation)</strong></td><td>[Focus]</td><td>[Action]</td></tr>
        <tr><td><strong>Day 60 (Co-Creation)</strong></td><td>[Focus]</td><td>[Action]</td></tr>
        <tr><td><strong>Day 90 (Close)</strong></td><td>[Focus]</td><td>[Action]</td></tr>
      </table>
      
      <h4 style="color:#CA2027; margin-top:30px;">Leadership Inspection Questions</h4>
      <ul style="font-size:0.9rem;">
        <li>Is buyer signal documented for each whitespace area? (Y/N)</li>
        <li>Is the Economic Buyer confirmed "Trusted"? (Y/N)</li>
      </ul>
    </div>
  `;

  const html = await callOpenAI(prompt);
  if(html) renderOutput(html);
}

/* =========================================
   BACKEND CALLER (Render Proxy)
   ========================================= */
async function callOpenAI(prompt) {
  document.getElementById('loader').style.display = 'block';
  document.getElementById('output-wrapper').style.display = 'none';

  try {
    const response = await fetch(`${API_BASE}/api/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, model: "gpt-4o-mini" })
    });

    const data = await response.json();
    document.getElementById('loader').style.display = 'none';

    if (!response.ok) {
      alert("Server Error: " + (data.error || response.statusText));
      console.error("Backend error:", data);
      return null;
    }

    return (data.html || "").replace(/```html/g, "").replace(/```/g, "");

  } catch (e) {
    document.getElementById('loader').style.display = 'none';
    alert("Network Error: " + e.message);
    console.error("Network error:", e);
    return null;
  }
}

function renderOutput(html) {
  document.getElementById('view-maturity').classList.add('hidden');
  document.getElementById('view-simplified').classList.add('hidden');
  document.getElementById('view-detailed').classList.add('hidden');
  document.getElementById('lobby').classList.add('hidden');
  
  const out = document.getElementById('output-content');
  out.innerHTML = html;
  
  const wrapper = document.getElementById('output-wrapper');
  wrapper.style.display = 'block';
  wrapper.scrollIntoView({behavior: 'smooth'});
}
</script>
</body>
</html>

